<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  

  
  <title>springboot+mysql读写分离 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="SpringBoot下MySQL的读写分离环境：SpringBoot：2.0.3    DB:MySQL5.7.20 主从模式持久化框架：SpringDataJpa">
<meta property="og:type" content="article">
<meta property="og:title" content="springboot+mysql读写分离">
<meta property="og:url" content="http://yoursite.com/2019/03/11/springboot-mysql读写分离/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="SpringBoot下MySQL的读写分离环境：SpringBoot：2.0.3    DB:MySQL5.7.20 主从模式持久化框架：SpringDataJpa">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2019-07-18T13:02:47.428Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="springboot+mysql读写分离">
<meta name="twitter:description" content="SpringBoot下MySQL的读写分离环境：SpringBoot：2.0.3    DB:MySQL5.7.20 主从模式持久化框架：SpringDataJpa">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-springboot-mysql读写分离" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/03/11/springboot-mysql读写分离/" class="article-date">
  <time datetime="2019-03-11T13:09:11.000Z" itemprop="datePublished">2019-03-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      springboot+mysql读写分离
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="SpringBoot下MySQL的读写分离"><a href="#SpringBoot下MySQL的读写分离" class="headerlink" title="SpringBoot下MySQL的读写分离"></a>SpringBoot下MySQL的读写分离</h3><p>环境：<br>SpringBoot：2.0.3    DB:MySQL5.7.20 主从模式<br>持久化框架：SpringDataJpa</p>
<a id="more"></a>
<h4 id="1-多数据源的配置application-yml"><a href="#1-多数据源的配置application-yml" class="headerlink" title="1.多数据源的配置application.yml:"></a>1.多数据源的配置application.yml:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">#####MySQL数据库的主从配置开始#####</span><br><span class="line">mysql:</span><br><span class="line">datasource:</span><br><span class="line">readSize: 1 #读库个数,可以有多个</span><br><span class="line">type: com.alibaba.druid.pool.DruidDataSource</span><br><span class="line">write:</span><br><span class="line">url: jdbc:mysql://192.168.1.121:3306/db_frms?useUnicode=true&amp;characterEncoding=utf-8</span><br><span class="line">username: root</span><br><span class="line">password: 123456</span><br><span class="line">driver-class-name: com.mysql.jdbc.Driver</span><br><span class="line">minIdle: 5</span><br><span class="line">maxActive: 100</span><br><span class="line">initialSize: 10</span><br><span class="line">maxWait: 60000</span><br><span class="line">timeBetweenEvictionRunsMillis: 60000</span><br><span class="line">minEvictableIdleTimeMillis: 300000</span><br><span class="line">validationQuery: select &apos;x&apos;</span><br><span class="line">testWhileIdle: true</span><br><span class="line">testOnBorrow: false</span><br><span class="line">testOnReturn: false</span><br><span class="line">poolPreparedStatements: true</span><br><span class="line">maxPoolPreparedStatementPerConnectionSize: 50</span><br><span class="line">removeAbandoned: true</span><br><span class="line">filters: stat</span><br><span class="line">read01:</span><br><span class="line">url: jdbc:mysql://192.168.1.121:3307/db_frms?useUnicode=true&amp;characterEncoding=utf-8</span><br><span class="line">username: root</span><br><span class="line">password: 123456</span><br><span class="line">driver-class-name: com.mysql.jdbc.Driver</span><br><span class="line">minIdle: 5</span><br><span class="line">maxActive: 100</span><br><span class="line">initialSize: 10</span><br><span class="line">maxWait: 60000</span><br><span class="line">timeBetweenEvictionRunsMillis: 60000</span><br><span class="line">minEvictableIdleTimeMillis: 300000</span><br><span class="line">validationQuery: select &apos;x&apos;</span><br><span class="line">testWhileIdle: true</span><br><span class="line">testOnBorrow: false</span><br><span class="line">testOnReturn: false</span><br><span class="line">poolPreparedStatements: true</span><br><span class="line">maxPoolPreparedStatementPerConnectionSize: 50</span><br><span class="line">removeAbandoned: true</span><br><span class="line">filters: stat</span><br><span class="line"># read02:	#因为我只用docker配置了一个slave，所以没有第二个slave，故这段配置注释掉！</span><br><span class="line"># url: jdbc:mysql://192.168.1.121:3308/test_02?useUnicode=true&amp;characterEncoding=utf-8</span><br><span class="line"># username: root</span><br><span class="line"># password: root</span><br><span class="line"># driver-class-name: com.mysql.jdbc.Driver</span><br><span class="line"># minIdle: 5</span><br><span class="line"># maxActive: 100</span><br><span class="line"># initialSize: 10</span><br><span class="line"># maxWait: 60000</span><br><span class="line"># timeBetweenEvictionRunsMillis: 60000</span><br><span class="line"># minEvictableIdleTimeMillis: 300000</span><br><span class="line"># validationQuery: select &apos;x&apos;</span><br><span class="line"># testWhileIdle: true</span><br><span class="line"># testOnBorrow: false</span><br><span class="line"># testOnReturn: false</span><br><span class="line"># poolPreparedStatements: true</span><br><span class="line"># maxPoolPreparedStatementPerConnectionSize: 50</span><br><span class="line"># removeAbandoned: true</span><br><span class="line"># filters: stat</span><br><span class="line">#####MySQL数据库的主从配置结束#####</span><br></pre></td></tr></table></figure>

<h4 id="2-定义数据库的类型枚举类DataSourceType："><a href="#2-定义数据库的类型枚举类DataSourceType：" class="headerlink" title="2.定义数据库的类型枚举类DataSourceType："></a>2.定义数据库的类型枚举类DataSourceType：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">package com.ddbin.frms.config.datasource;</span><br><span class="line"></span><br><span class="line">import lombok.AllArgsConstructor;</span><br><span class="line">import lombok.Getter;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Description:数据源类型的枚举类</span><br><span class="line"> *</span><br><span class="line"> * @param</span><br><span class="line"> * @author dbdu</span><br><span class="line"> * @date 18-7-14 上午8:05</span><br><span class="line"> */</span><br><span class="line">@Getter</span><br><span class="line">@AllArgsConstructor</span><br><span class="line">public enum DataSourceType &#123;</span><br><span class="line"></span><br><span class="line">    read(&quot;read&quot;, &quot;从库&quot;), write(&quot;write&quot;, &quot;主库&quot;);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Description:类型，是读还是写</span><br><span class="line">     *</span><br><span class="line">     * @author dbdu</span><br><span class="line">     * @date 18-7-14 上午8:14</span><br><span class="line">     */</span><br><span class="line">    private String type;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Description:数据源的名称</span><br><span class="line">     *</span><br><span class="line">     * @author dbdu</span><br><span class="line">     * @date 18-7-14 上午8:15</span><br><span class="line">     */</span><br><span class="line">    private String name;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>要注意的是：枚举实例小写，大写会报错！！<br>read(“read”, “从库”), write(“write”, “主库”);<br>3.多个数据源的实例化配置类DataSourceConfiguration：<br>有多少个数据源，就配置多少个对应的Bean。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">package com.ddbin.frms.config.datasource;</span><br><span class="line"></span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.springframework.beans.factory.annotation.Value;</span><br><span class="line">import org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line">import org.springframework.boot.jdbc.DataSourceBuilder;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.context.annotation.Primary;</span><br><span class="line"></span><br><span class="line">import javax.sql.DataSource;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Description:MySQL读写主从数据库源配置</span><br><span class="line"> *</span><br><span class="line"> * @param</span><br><span class="line"> * @author dbdu</span><br><span class="line"> * @date 18-7-14 上午7:51</span><br><span class="line"> * @return</span><br><span class="line"> */</span><br><span class="line">@Configuration</span><br><span class="line">@Slf4j</span><br><span class="line">public class DataSourceConfiguration &#123;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;mysql.datasource.type&#125;&quot;)</span><br><span class="line">    private Class&lt;? extends DataSource&gt; dataSourceType;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 写库 数据源配置</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Bean(name = &quot;writeDataSource&quot;)</span><br><span class="line">    @Primary</span><br><span class="line">    @ConfigurationProperties(prefix = &quot;mysql.datasource.write&quot;)</span><br><span class="line">    public DataSource writeDataSource() &#123;</span><br><span class="line">        log.info(&quot;writeDataSource init ...&quot;);</span><br><span class="line">        return DataSourceBuilder.create().type(dataSourceType).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 有多少个从库就要配置多少个</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Bean(name = &quot;readDataSource01&quot;)</span><br><span class="line">    @ConfigurationProperties(prefix = &quot;mysql.datasource.read01&quot;)</span><br><span class="line">    public DataSource readDataSourceOne() &#123;</span><br><span class="line">        log.info(&quot;read01 DataSourceOne init ...&quot;);</span><br><span class="line">        return DataSourceBuilder.create().type(dataSourceType).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">//    @Bean(name = &quot;readDataSource02&quot;)</span><br><span class="line">//    @ConfigurationProperties(prefix = &quot;mysql.datasource.read02&quot;)</span><br><span class="line">//    public DataSource readDataSourceTwo() &#123;</span><br><span class="line">//        log.info(&quot;read02 DataSourceTwo init ...&quot;);</span><br><span class="line">//        return DataSourceBuilder.create().type(dataSourceType).build();</span><br><span class="line">//    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-配置数据源的切换类DataSourceContextHolder"><a href="#4-配置数据源的切换类DataSourceContextHolder" class="headerlink" title="4.配置数据源的切换类DataSourceContextHolder"></a>4.配置数据源的切换类DataSourceContextHolder</h4><p>设置这个类的对应的read和write，就被内部用来读取不同的数据源</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">package com.ddbin.frms.config.datasource;</span><br><span class="line"></span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Description:本地线程，数据源上下文切换</span><br><span class="line"> *</span><br><span class="line"> * @author dbdu</span><br><span class="line"> * @date 18-7-14 上午8:17</span><br><span class="line"> */</span><br><span class="line">@Slf4j</span><br><span class="line">public class DataSourceContextHolder &#123;</span><br><span class="line">    //线程本地环境</span><br><span class="line">    private static final ThreadLocal&lt;String&gt; local = new ThreadLocal&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">    public static ThreadLocal&lt;String&gt; getLocal() &#123;</span><br><span class="line">        return local;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 读库</span><br><span class="line">     */</span><br><span class="line">    public static void setRead() &#123;</span><br><span class="line">        local.set(DataSourceType.read.getType());</span><br><span class="line">        //log.info(&quot;数据库切换到READ库...&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 写库</span><br><span class="line">     */</span><br><span class="line">    public static void setWrite() &#123;</span><br><span class="line">        local.set(DataSourceType.write.getType());</span><br><span class="line">        // log.info(&quot;数据库切换到WRITE库...&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static String getReadOrWrite() &#123;</span><br><span class="line">        return local.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void clear() &#123;</span><br><span class="line">        local.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-数据源的代理路由配置DatasourceAgentConfig"><a href="#5-数据源的代理路由配置DatasourceAgentConfig" class="headerlink" title="5.数据源的代理路由配置DatasourceAgentConfig"></a>5.数据源的代理路由配置DatasourceAgentConfig</h4><p>请读者特别注意这个类，网上很多说的都是mybatis框架的，这里是SpringDataJpa框架对应的关联代理数据源路由的配置，此处配置出错就会失败！</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">package com.ddbin.frms.config.datasource;</span><br><span class="line"></span><br><span class="line">import com.ddbin.frms.FrmsApplication;</span><br><span class="line">import com.ddbin.frms.util.SpringContextsUtil;</span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line">import org.springframework.beans.factory.annotation.Value;</span><br><span class="line">import org.springframework.boot.autoconfigure.AutoConfigureAfter;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource;</span><br><span class="line">import org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean;</span><br><span class="line">import org.springframework.orm.jpa.vendor.Database;</span><br><span class="line">import org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter;</span><br><span class="line">import org.springframework.transaction.annotation.EnableTransactionManagement;</span><br><span class="line"></span><br><span class="line">import javax.persistence.EntityManagerFactory;</span><br><span class="line">import javax.sql.DataSource;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">@Configuration</span><br><span class="line">@AutoConfigureAfter(DataSourceConfiguration.class)</span><br><span class="line">@EnableTransactionManagement(order = 10)</span><br><span class="line">@Slf4j</span><br><span class="line">public class DatasourceAgentConfig &#123;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;mysql.datasource.readSize&#125;&quot;)</span><br><span class="line">    private String readDataSourceSize;</span><br><span class="line"></span><br><span class="line">    private AbstractRoutingDataSource proxy;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    @Qualifier(&quot;writeDataSource&quot;)</span><br><span class="line">    private DataSource writeDataSource;</span><br><span class="line">    @Autowired</span><br><span class="line">    @Qualifier(&quot;readDataSource01&quot;)</span><br><span class="line">    private DataSource readDataSource01;</span><br><span class="line">//    @Autowired</span><br><span class="line">//    @Qualifier(&quot;readDataSource02&quot;)</span><br><span class="line">//    private DataSource readDataSource02;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 把所有数据库都放在路由中</span><br><span class="line">     * 重点是roundRobinDataSouceProxy()方法，它把所有的数据库源交给AbstractRoutingDataSource类，</span><br><span class="line">     * 并由它的determineCurrentLookupKey()进行决定数据源的选择，其中读库进行了简单的负载均衡（轮询）。</span><br><span class="line">     *</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Bean(name = &quot;roundRobinDataSouceProxy&quot;)</span><br><span class="line">    public AbstractRoutingDataSource roundRobinDataSouceProxy() &#123;</span><br><span class="line"></span><br><span class="line">        /**</span><br><span class="line">         * Description:把所有数据库都放在targetDataSources中,注意key值要和determineCurrentLookupKey()中代码写的一至，</span><br><span class="line">         *     否则切换数据源时找不到正确的数据源</span><br><span class="line">         */</span><br><span class="line">        Map&lt;Object, Object&gt; targetDataSources = new HashMap&lt;Object, Object&gt;();</span><br><span class="line"></span><br><span class="line">        targetDataSources.put(DataSourceType.write.getType(), writeDataSource);</span><br><span class="line">        targetDataSources.put(DataSourceType.read.getType() + &quot;1&quot;, readDataSource01);</span><br><span class="line">        //targetDataSources.put(DataSourceType.read.getType() + &quot;2&quot;, readDataSource02);</span><br><span class="line"></span><br><span class="line">        //路由类，寻找对应的数据源</span><br><span class="line">        final int readSize = Integer.parseInt(readDataSourceSize);</span><br><span class="line">        MyAbstractRoutingDataSource proxy = new MyAbstractRoutingDataSource(readSize);</span><br><span class="line"></span><br><span class="line">        proxy.setTargetDataSources(targetDataSources);</span><br><span class="line">        //默认库</span><br><span class="line">        proxy.setDefaultTargetDataSource(writeDataSource);</span><br><span class="line">        this.proxy = proxy;</span><br><span class="line">        return proxy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Description:要特别注意，这个Bean是配置读写分离成败的关键，</span><br><span class="line">     *</span><br><span class="line">     * @param []</span><br><span class="line">     * @return org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean</span><br><span class="line">     * @author dbdu</span><br><span class="line">     * @date 18-7-15 下午5:08</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public LocalContainerEntityManagerFactoryBean entityManagerFactory() &#123;</span><br><span class="line">        HibernateJpaVendorAdapter vendorAdapter = new HibernateJpaVendorAdapter();</span><br><span class="line">        vendorAdapter.setDatabase(Database.MYSQL);</span><br><span class="line">        //是否生成表</span><br><span class="line">             vendorAdapter.setGenerateDdl(true);</span><br><span class="line">        //是否显示sql语句</span><br><span class="line">            vendorAdapter.setShowSql(true);</span><br><span class="line"></span><br><span class="line">        LocalContainerEntityManagerFactoryBean factory = new LocalContainerEntityManagerFactoryBean();</span><br><span class="line">        factory.setJpaVendorAdapter(vendorAdapter);</span><br><span class="line">        //配置扫描的位置</span><br><span class="line">        factory.setPackagesToScan(FrmsApplication.class.getPackage().getName());</span><br><span class="line">        // 这个数据源设置为代理的数据源，----这是关键性配置！！！</span><br><span class="line">        factory.setDataSource(proxy);</span><br><span class="line">        return factory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Bean(name = &quot;transactionManager&quot;)</span><br><span class="line">    public MyJpaTransactionManager transactionManager() &#123;</span><br><span class="line"></span><br><span class="line">        MyJpaTransactionManager transactionManager = new MyJpaTransactionManager();</span><br><span class="line">        transactionManager.setDataSource(proxy);</span><br><span class="line">        transactionManager.setEntityManagerFactory((EntityManagerFactory) SpringContextsUtil.getBean(&quot;entityManagerFactory&quot;));</span><br><span class="line">        return transactionManager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="6-自定义的路由数据源及事务管理器的子类："><a href="#6-自定义的路由数据源及事务管理器的子类：" class="headerlink" title="6.自定义的路由数据源及事务管理器的子类："></a>6.自定义的路由数据源及事务管理器的子类：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">package com.ddbin.frms.config.datasource;</span><br><span class="line"></span><br><span class="line">import lombok.AllArgsConstructor;</span><br><span class="line">import lombok.Getter;</span><br><span class="line">import lombok.Setter;</span><br><span class="line">import org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Description: 抽象数据源的路由的子类</span><br><span class="line"> * Created at:2018-07-15 13:37,</span><br><span class="line"> * by dbdu</span><br><span class="line"> */</span><br><span class="line">@Getter</span><br><span class="line">@Setter</span><br><span class="line">@AllArgsConstructor</span><br><span class="line">public class MyAbstractRoutingDataSource extends AbstractRoutingDataSource &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Description:读库的数量，可以用来实现负载均衡</span><br><span class="line">     */</span><br><span class="line">    private int readSize;</span><br><span class="line"></span><br><span class="line">    //private AtomicLong count = new AtomicLong(0);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 这是AbstractRoutingDataSource类中的一个抽象方法，</span><br><span class="line">     * 而它的返回值是你所要用的数据源dataSource的key值，有了这个key值，</span><br><span class="line">     * targetDataSources就从中取出对应的DataSource，如果找不到，就用配置默认的数据源。</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    protected Object determineCurrentLookupKey() &#123;</span><br><span class="line">        String typeKey = DataSourceContextHolder.getReadOrWrite();</span><br><span class="line"></span><br><span class="line">        if (typeKey == null || typeKey.equals(DataSourceType.write.getType())) &#123;</span><br><span class="line">            System.err.println(&quot;使用数据库write.............&quot;);</span><br><span class="line">            return DataSourceType.write.getType();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            //读库， 简单负载均衡</span><br><span class="line">//                    int number = count.getAndAdd(1);</span><br><span class="line">//                    int lookupKey = number % readSize;</span><br><span class="line">//                    System.err.println(&quot;使用数据库read-&quot; + (lookupKey + 1));</span><br><span class="line">//                    return DataSourceType.read.getType() + (lookupKey + 1);</span><br><span class="line"></span><br><span class="line">            return DataSourceType.read.getType() + &quot;1&quot;;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">package com.ddbin.frms.config.datasource;</span><br><span class="line"></span><br><span class="line">import lombok.extern.slf4j.Slf4j;</span><br><span class="line">import org.springframework.orm.jpa.JpaTransactionManager;</span><br><span class="line">import org.springframework.transaction.TransactionDefinition;</span><br><span class="line">import org.springframework.transaction.support.DefaultTransactionStatus;</span><br><span class="line"></span><br><span class="line">@SuppressWarnings(&quot;serial&quot;)</span><br><span class="line">@Slf4j</span><br><span class="line">public class MyJpaTransactionManager extends JpaTransactionManager &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected void doBegin(Object transaction, TransactionDefinition definition) &#123;</span><br><span class="line">        if (definition.isReadOnly()) &#123;</span><br><span class="line">            DataSourceContextHolder.setRead();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            DataSourceContextHolder.setWrite();</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(&quot;jpa-transaction:begin-----now dataSource is [&quot; + DataSourceContextHolder.getReadOrWrite() + &quot;]&quot;);</span><br><span class="line">        super.doBegin(transaction, definition);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected void doCommit(DefaultTransactionStatus status) &#123;</span><br><span class="line">        log.info(&quot;jpa-transaction:commit-----now dataSource is [&quot; + DataSourceContextHolder.getReadOrWrite() + &quot;]&quot;);</span><br><span class="line">        super.doCommit(status);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line">---------------------</span><br></pre></td></tr></table></figure>

<p>说明：如果方法命名不符合规则，也没有加注解，则typeKey会有可能为null，下面的逻辑是<br>typeKey为空使用写库！—也就是主库。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">* 这是AbstractRoutingDataSource类中的一个抽象方法，</span><br><span class="line">* 而它的返回值是你所要用的数据源dataSource的key值，有了这个key值，</span><br><span class="line">* targetDataSources就从中取出对应的DataSource，如果找不到，就用配置默认的数据源。</span><br><span class="line">*/</span><br><span class="line">@Override</span><br><span class="line">protected Object determineCurrentLookupKey() &#123;</span><br><span class="line">String typeKey = DataSourceContextHolder.getReadOrWrite();</span><br><span class="line"></span><br><span class="line">if (typeKey == null || typeKey.equals(DataSourceType.write.getType())) &#123;</span><br><span class="line">System.err.println(&quot;使用数据库write.............&quot;);</span><br><span class="line">return DataSourceType.write.getType();</span><br><span class="line">&#125; else &#123;</span><br><span class="line">//读库， 简单负载均衡</span><br><span class="line">// int number = count.getAndAdd(1);</span><br><span class="line">// int lookupKey = number % readSize;</span><br><span class="line">// System.err.println(&quot;使用数据库read-&quot; + (lookupKey + 1));</span><br><span class="line">// return DataSourceType.read.getType() + (lookupKey + 1);</span><br><span class="line"></span><br><span class="line">return DataSourceType.read.getType() + &quot;1&quot;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="7-读写数据源的注解，非必需，有则可以更加灵活："><a href="#7-读写数据源的注解，非必需，有则可以更加灵活：" class="headerlink" title="7.读写数据源的注解，非必需，有则可以更加灵活："></a>7.读写数据源的注解，非必需，有则可以更加灵活：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">package com.ddbin.frms.config.datasource;</span><br><span class="line"></span><br><span class="line">import java.lang.annotation.*;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Description:读数据源的注解</span><br><span class="line"> *</span><br><span class="line"> * @author dbdu</span><br><span class="line"> * @date 18-7-14 上午8:21</span><br><span class="line"> */</span><br><span class="line">@Target(&#123;ElementType.METHOD, ElementType.TYPE&#125;)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Inherited</span><br><span class="line">@Documented</span><br><span class="line">public @interface ReadDataSource &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">package com.ddbin.frms.config.datasource;</span><br><span class="line"></span><br><span class="line">import java.lang.annotation.*;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Description:写数据源的注解</span><br><span class="line"> *</span><br><span class="line"> * @author dbdu</span><br><span class="line"> * @date 18-7-14 上午8:21</span><br><span class="line"> */</span><br><span class="line">@Target(&#123;ElementType.METHOD, ElementType.TYPE&#125;)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Inherited</span><br><span class="line">@Documented</span><br><span class="line">public @interface WriteDataSource &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="8-配置service切面，来切换不同的数据源"><a href="#8-配置service切面，来切换不同的数据源" class="headerlink" title="8.配置service切面，来切换不同的数据源"></a>8.配置service切面，来切换不同的数据源</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">package com.ddbin.frms.config.datasource;</span><br><span class="line"></span><br><span class="line">import org.aspectj.lang.annotation.Aspect;</span><br><span class="line">import org.aspectj.lang.annotation.Before;</span><br><span class="line">import org.springframework.context.annotation.EnableAspectJAutoProxy;</span><br><span class="line">import org.springframework.core.PriorityOrdered;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Description:在service层决定数据源</span><br><span class="line"> * 必须在事务AOP之前执行，所以实现Ordered,order的值越小，越先执行</span><br><span class="line"> * 如果一旦开始切换到写库，则之后的读都会走写库;</span><br><span class="line"> * 方法名符合切入点规则或加上读写注解都可以使用对应的数据库！！</span><br><span class="line"> *</span><br><span class="line"> * @author dbdu</span><br><span class="line"> * @date 18-7-14 上午8:32</span><br><span class="line"> */</span><br><span class="line">@Aspect</span><br><span class="line">@EnableAspectJAutoProxy(exposeProxy = true, proxyTargetClass = true)</span><br><span class="line">@Component</span><br><span class="line">public class DataSourceAopInService implements PriorityOrdered &#123;</span><br><span class="line"></span><br><span class="line">    @Before(&quot;execution(* com.ddbin.frms.service..*.find*(..)) &quot;</span><br><span class="line">            + &quot; or execution(* com.ddbin.frms.service..*.get*(..)) &quot;</span><br><span class="line">            + &quot; or execution(* com.ddbin.frms.service..*.query*(..))&quot;</span><br><span class="line">            + &quot; or execution(* com.ddbin.frms.service..*.list*(..))&quot;</span><br><span class="line">            + &quot; or @annotation(com.ddbin.frms.config.datasource.ReadDataSource) &quot;</span><br><span class="line">    )</span><br><span class="line">    public void setReadDataSourceType() &#123;</span><br><span class="line">        //如果已经开启写事务了，那之后的所有读都从写库读</span><br><span class="line">        if (!DataSourceType.write.getType().equals(DataSourceContextHolder.getReadOrWrite())) &#123;</span><br><span class="line">            DataSourceContextHolder.setRead();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Before(&quot;execution(* com.ddbin.frms.service..*.insert*(..)) &quot;</span><br><span class="line">            + &quot; or execution(* com.ddbin.frms.service..*.add*(..))&quot;</span><br><span class="line">            + &quot; or execution(* com.ddbin.frms.service..*.save*(..))&quot;</span><br><span class="line">            + &quot; or execution(* com.ddbin.frms.service..*.create*(..))&quot;</span><br><span class="line">            + &quot; or execution(* com.ddbin.frms.service..*.update*(..))&quot;</span><br><span class="line">            + &quot; or execution(* com.ddbin.frms.service..*.mod*(..))&quot;</span><br><span class="line">            + &quot; or execution(* com.ddbin.frms.service..*.delete*(..))&quot;</span><br><span class="line">            + &quot; or execution(* com.ddbin.frms.service..*.del*(..))&quot;</span><br><span class="line">            + &quot; or execution(* com.ddbin.frms.service..*.truncate*(..))&quot;</span><br><span class="line">            + &quot; or @annotation(com.ddbin.frms.config.datasource.WriteDataSource) &quot;</span><br><span class="line">    )</span><br><span class="line">    public void setWriteDataSourceType() &#123;</span><br><span class="line">        DataSourceContextHolder.setWrite();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public int getOrder() &#123;</span><br><span class="line">        /**</span><br><span class="line">         * 值越小，越优先执行</span><br><span class="line">         * 要优于事务的执行</span><br><span class="line">         * 在启动类中加上了@EnableTransactionManagement(order = 10)</span><br><span class="line">         */</span><br><span class="line">        return 1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>说明:<br>A.如果方法的命名符合切入点的规则，则自动设定使用需要的数据源;<br>B.如果不符合A 的方法命名规则，使用注解也一样。<br>C.如果方法命名不符合A 的规则也没有对应的注解 ，则默认使用主库！<br>特别注意：<br>一定不要对从库或说read库进行写操作，这样做的后果是，轻者导致数据不一致(主库到从库的单向同步)，重者导致从库同步失败，主库的更改不会同步到从库！<br>因此，写库注解可以加到service的任意方法上，因为是操作主库，但是读库注解不能加到写的方法上！</p>
<h4 id="9-测试用类：读者自己去写就好了。"><a href="#9-测试用类：读者自己去写就好了。" class="headerlink" title="9.测试用类：读者自己去写就好了。"></a>9.测试用类：读者自己去写就好了。</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Description:这个方法用来测试 方法名不符合规范及注解不同是什么效果！！</span><br><span class="line"> * 方法名不符合规则也没有注解，默认走主库！</span><br><span class="line"> *</span><br><span class="line"> * @author dbdu</span><br><span class="line"> * @date 18-7-15 下午5:45</span><br><span class="line"> */</span><br><span class="line">@ReadDataSource</span><br><span class="line">@Override</span><br><span class="line">public Page&lt;Employee&gt; pageByName(String userName, Pageable page) &#123;</span><br><span class="line">    Page&lt;Employee&gt; page1 = employeeRepository.findByName(userName, page);</span><br><span class="line">    return page1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/03/11/springboot-mysql读写分离/" data-id="cjydsg9h8000sz0nw6m164ocu" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/03/19/map/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          map
        
      </div>
    </a>
  
  
    <a href="/2019/03/11/重入锁/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">重入锁</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/悲观锁、乐观锁、可重入锁、自旋锁、偏向锁、轻量-重量级锁、读写锁、各种锁及其Java实现/">悲观锁、乐观锁、可重入锁、自旋锁、偏向锁、轻量/重量级锁、读写锁、各种锁及其Java实现</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/悲观锁、乐观锁、可重入锁、自旋锁、偏向锁、轻量-重量级锁、读写锁、各种锁及其Java实现/" style="font-size: 10px;">悲观锁、乐观锁、可重入锁、自旋锁、偏向锁、轻量/重量级锁、读写锁、各种锁及其Java实现</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/07/22/跳表/">跳表</a>
          </li>
        
          <li>
            <a href="/2019/07/18/integer/">integer</a>
          </li>
        
          <li>
            <a href="/2019/07/16/lock/">lock</a>
          </li>
        
          <li>
            <a href="/2019/07/16/lock_20190718_210149/">lock</a>
          </li>
        
          <li>
            <a href="/2019/06/22/redis-cluster/">redis-cluster</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>